<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Weapon HUD</title>

  <!-- Portals SDK -->
  <script src="https://portals-labs.github.io/portals-sdk/portals-sdk.js?v=10005456"></script>

  <style>
    :root {
      --hud-w: 120px;
      --slot-h: 72px;
      --text: rgba(255,255,255,0.94);
      --muted: rgba(255,255,255,0.68);
      --shadow: rgba(0,0,0,0.65);
    }

    html, body {
      height: 100%;
      margin: 0;
      background: transparent;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
    }

    /* Position like a HUD element (top-right) */
    .hud {
      position: fixed;
      top: 18px;
      right: 18px;
      width: min(var(--hud-w), 92vw);
      display: grid;
      gap: 14px;
      pointer-events: none;
    }

    .slot {
      position: relative;
      height: var(--slot-h);
      display: grid;
      grid-template-columns: minmax(0, 1fr) 22px;
      column-gap: 6px;
      align-items: center;
      isolation: isolate;
      opacity: 0.72;
      transition: opacity 160ms ease-out;
    }

    .slot > * {
      position: relative;
      z-index: 1;
    }

    /* Active shadow fades out to the LEFT (strongest near the right edge) */
    .slot.active::before {
      content: "";
      position: absolute;
      top: -2px;
      bottom: -2px;
      right: -2px;
      left: -70px;
      background: linear-gradient(to left, rgba(0,0,0,0.38) 0%, rgba(0,0,0,0) 55%);
      border-radius: 16px;
      box-shadow: 0 6px 12px rgba(0,0,0,0.14);
      pointer-events: none;
      z-index: 0;
    }

    .slot.active {
      opacity: 1;
    }

    .main {
      display: grid;
      justify-items: end;
      align-content: center;
      row-gap: 1px;
      min-width: 0;
      overflow: visible; /* allow icon/text to extend left */
    }

    .weaponIcon {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      width: 100%;
      justify-self: end;
      min-width: 0;
      overflow: visible;
      height: 44px;
    }

    .weaponIcon svg {
      width: 260px;            /* bigger silhouettes (can overflow left) */
      max-width: none;
      height: 44px;
      display: block;
      margin-left: auto;       /* keep right edge fixed */
      filter: drop-shadow(0 2px 10px rgba(0,0,0,0.35));
    }

    .weaponName {$1pointer-events: none;
      transform: translateY(-4px);
    }

    .slotNum {
      justify-self: end;
      align-self: start;
      font-weight: 900;
      font-size: 12px;
      color: rgba(255,255,255,0.95);
      text-shadow: 0 2px 10px var(--shadow);
      transform: translate(-10px, 2px);
      user-select: none;
    }

    /* Optional debug (hidden by default to match CS look) */
    .debug {
      display: none;
      font-size: 11px;
      opacity: 0.55;
      text-align: right;
      text-shadow: 0 2px 10px var(--shadow);
    }

    @keyframes activePop {
      0% { transform: scale(1); }
      35% { transform: scale(1.02); }
      100% { transform: scale(1); }
    }

    .slot.justActivated {
      animation: activePop 240ms ease-out 1;
    }
  </style>
</head>
<body>
  <div class="hud" aria-label="Weapon HUD">
    <div class="slot" id="slotPrimary">
      <div class="main">
        <div class="weaponIcon" id="iconPrimary" aria-hidden="true"></div>
        <div class="weaponName" id="namePrimary">Shotgun</div>
      </div>
      <div class="slotNum">1</div>
    </div>

    <div class="slot" id="slotSecondary">
      <div class="main">
        <div class="weaponIcon" id="iconSecondary" aria-hidden="true"></div>
        <div class="weaponName" id="nameSecondary">Pistol</div>
      </div>
      <div class="slotNum">2</div>
    </div>

    <div class="debug" id="debugText">Listening for SDK messages…</div>
  </div>

  <script>
    // Placeholder "images": simple inline SVG icons for now
    // You can swap these for <img> tags later.
    const ICONS = {
      Shotgun: svgIcon("Shotgun"),
      Sniper: svgIcon("Sniper"),
      MachineGun: svgIcon("MachineGun"),
      Pistol: svgIcon("Pistol"),
      HealingGun: svgIcon("HealingGun"),
      Unknown: svgIcon("Unknown"),
    };

    function svgIcon(type) {
      // Bigger, knife-like placeholder silhouettes.
      // All icons share the same wide viewBox and are drawn RIGHT-ANCHORED
      // so the right edge stays fixed while the left can extend.
      const label = type.replace(/([a-z])([A-Z])/g, "$1 $2");
      const F = 'rgba(255,255,255,0.92)';

      const svgOpen = `<svg viewBox="0 0 220 32" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="${label}" preserveAspectRatio="xMaxYMid meet">`;
      const svgClose = `</svg>`;

      const rect = (x, y, w, h, rx = 1.2) => `<rect x="${x}" y="${y}" width="${w}" height="${h}" rx="${rx}" fill="${F}" />`;
      const poly = (pts) => `<polygon points="${pts}" fill="${F}" />`;

      // Right edge target: x = 216
      let parts = '';
      switch (type) {
        case 'Shotgun':
          parts += rect(34, 14, 182, 4);       // ends at 216
          parts += rect(16, 12, 18, 8);
          parts += rect(100, 18, 30, 3, 1.0);
          parts += rect(68, 18, 10, 10, 1.0);
          break;

        case 'Sniper':
          parts += rect(24, 15, 192, 3, 1.0);
          parts += rect(10, 12, 16, 8);
          parts += rect(134, 9, 36, 4, 1.2);
          parts += rect(60, 18, 9, 10, 1.0);
          parts += rect(210, 14, 6, 6, 0.8);
          break;

        case 'MachineGun':
          parts += rect(30, 13, 186, 5);
          parts += rect(12, 12, 18, 9);
          parts += rect(94, 19, 26, 12, 1.2);
          parts += rect(62, 18, 10, 10, 1.0);
          parts += rect(120, 11, 56, 2, 0.8);
          break;

        case 'Pistol':
          parts += rect(126, 14, 90, 4);
          parts += rect(176, 18, 16, 12, 1.2);
          parts += poly('168,18 176,18 176,22 168,22');
          break;

        case 'HealingGun':
          parts += rect(40, 14, 176, 4);
          parts += rect(20, 12, 20, 8);
          parts += rect(76, 18, 10, 10, 1.0);
          parts += rect(150, 6, 6, 20, 0.8);
          parts += rect(142, 14, 22, 6, 0.8);
          break;

        default:
          parts += rect(108, 13, 108, 6);
          parts += rect(182, 20, 18, 10);
          break;
      }

      return `${svgOpen}${parts}${svgClose}`;
    }

    // UI elements
    const slotPrimary = document.getElementById('slotPrimary');
    const slotSecondary = document.getElementById('slotSecondary');

    const iconPrimary = document.getElementById('iconPrimary');
    const iconSecondary = document.getElementById('iconSecondary');

    const namePrimary = document.getElementById('namePrimary');
    const nameSecondary = document.getElementById('nameSecondary');

    const debugText = document.getElementById('debugText');

    let lastActive = null;

    // Only parse these parts from the message:
    //   PrimaryWeapon="..."  SecondaryWeapon="..."  ActiveWeapon="Primary"|"Secondary"
    function parseWeaponMessage(message) {
      const str = String(message);

      // Match quoted values (your example uses quotes). Also tolerates unquoted words.
      const primaryMatch = str.match(/PrimaryWeapon *= *(?:"([^"]+)"|([^ ]+))/);
      const secondaryMatch = str.match(/SecondaryWeapon *= *(?:"([^"]+)"|([^ ]+))/);
      const activeMatch = str.match(/ActiveWeapon *= *(?:"(Primary|Secondary)"|(Primary|Secondary))/);

      if (!primaryMatch || !secondaryMatch || !activeMatch) return null;

      const primary = (primaryMatch[1] ?? primaryMatch[2] ?? "").trim();
      const secondary = (secondaryMatch[1] ?? secondaryMatch[2] ?? "").trim();
      const active = (activeMatch[1] ?? activeMatch[2] ?? "").trim();

      return { primary, secondary, active };
    }

    function normalizeWeaponName(name) {
      // Accept exact set; otherwise Unknown.
      // Also allow small variations (case-insensitive).
      const trimmed = String(name || "").trim();
      const key = Object.keys(ICONS).find(k => k.toLowerCase() === trimmed.toLowerCase());
      return key || 'Unknown';
    }

    function setSlot(slotEl, iconEl, nameEl, weaponName) {
      const normalized = normalizeWeaponName(weaponName);
      nameEl.textContent = normalized === 'Unknown' ? weaponName || 'Unknown' : normalized;
      iconEl.innerHTML = ICONS[normalized] || ICONS.Unknown;
    }

    function setActive(active) {
      slotPrimary.classList.toggle('active', active === 'Primary');
      slotSecondary.classList.toggle('active', active === 'Secondary');

      if (active && active !== lastActive) {
        const target = active === 'Primary' ? slotPrimary : slotSecondary;
        target.classList.remove('justActivated');
        void target.offsetWidth;
        target.classList.add('justActivated');
        clearTimeout(target._t);
        target._t = setTimeout(() => target.classList.remove('justActivated'), 320);
      }

      lastActive = active;
    }

    function applyState(state) {
      setSlot(slotPrimary, iconPrimary, namePrimary, state.primary);
      setSlot(slotSecondary, iconSecondary, nameSecondary, state.secondary);
      setActive(state.active);

      debugText.textContent = `Primary=${state.primary}  Secondary=${state.secondary}  Active=${state.active}`;
    }

    // Initialize with defaults
    applyState({ primary: 'Shotgun', secondary: 'Pistol', active: 'Primary' });

    // SDK listener (assume present)
    try {
      PortalsSdk.setMessageListener((message) => {
        console.log('PORTALS MSG:', message);

        const parsed = parseWeaponMessage(message);
        if (!parsed) {
          debugText.textContent = `Missing weapon fields in message.`;
          return;
        }

        // Only act on these fields; ignore everything else.
        applyState(parsed);
      });

      debugText.textContent = 'Listening for SDK messages…';
    } catch (e) {
      console.error(e);
      debugText.textContent = 'PortalsSdk not available.';
    }
    PortalsSdk.focusGameKeyboard();
  </script>
</body>
</html>
